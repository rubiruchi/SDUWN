<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Using LISP tunneling &mdash; Open vSwitch 2.6.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.6.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Open vSwitch 2.6.0 documentation" href="../index.html" />
    <link rel="up" title="How-to Guides" href="index.html" />
    <link rel="next" title="Connecting VMs Using Tunnels" href="tunneling.html" />
    <link rel="prev" title="Open vSwitch with SSL" href="ssl.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="tunneling.html" title="Connecting VMs Using Tunnels"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ssl.html" title="Open vSwitch with SSL"
             accesskey="P">previous</a> |</li>
        <li><a href="../contents.html">Open vSwitch 2.6.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">How-to Guides</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="using-lisp-tunneling">
<h1>Using LISP tunneling<a class="headerlink" href="#using-lisp-tunneling" title="Permalink to this headline">Â¶</a></h1>
<p>LISP is a layer 3 tunneling mechanism, meaning that encapsulated packets do not
carry Ethernet headers, and ARP requests shouldn&#8217;t be sent over the tunnel.
Because of this, there are some additional steps required for setting up LISP
tunnels in Open vSwitch, until support for L3 tunnels will improve.</p>
<p>This guide assumes tunneling between two VMs connected to OVS bridges on
different hypervisors reachable over IPv4.  Of course, more than one VM may be
connected to any of the hypervisors, and a hypervisor may communicate with
several different hypervisors over the same lisp tunneling interface.  A LISP
&#8220;map-cache&#8221; can be implemented using flows, see example at the bottom of this
file.</p>
<p>There are several scenarios:</p>
<ol class="arabic simple">
<li>the VMs have IP addresses in the same subnet and the hypervisors are also
in a single subnet (although one different from the VM&#8217;s);</li>
<li>the VMs have IP addresses in the same subnet but the hypervisors are
separated by a router;</li>
<li>the VMs are in different subnets.</li>
</ol>
<p>In cases 1) and 3) ARP resolution can work as normal: ARP traffic is configured
not to go through the LISP tunnel.  For case 1) ARP is able to reach the other
VM, if both OVS instances default to MAC address learning.  Case 3) requires
the hypervisor be configured as the default router for the VMs.</p>
<p>In case 2) the VMs expect ARP replies from each other, but this is not possible
over a layer 3 tunnel.  One solution is to have static MAC address entries
preconfigured on the VMs (e.g., <tt class="docutils literal"><span class="pre">arp</span> <span class="pre">-f</span> <span class="pre">/etc/ethers</span></tt> on startup on Unix based
VMs), or have the hypervisor do proxy ARP.  In this scenario, the eth0
interfaces need not be added to the br0 bridge in the examples below.</p>
<p>On the receiving side, the packet arrives without the original MAC header.  The
LISP tunneling code attaches a header with harcoded source and destination MAC
address <tt class="docutils literal"><span class="pre">02:00:00:00:00:00</span></tt>.  This address has all bits set to 0, except the
locally administered bit, in order to avoid potential collisions with existing
allocations.  In order for packets to reach their intended destination, the
destination MAC address needs to be rewritten.  This can be done using the flow
table.</p>
<p>See below for an example setup, and the associated flow rules to enable LISP
tunneling.</p>
<div class="highlight-python"><div class="highlight"><pre>Diagram

       +---+                               +---+
       |VM1|                               |VM2|
       +---+                               +---+
         |                                   |
    +--[tap0]--+                       +--[tap0]---+
    |          |                       |           |
[lisp0] OVS1 [eth0]-----------------[eth0] OVS2 [lisp0]
    |          |                       |           |
    +----------+                       +-----------+
</pre></div>
</div>
<p>On each hypervisor, interfaces tap0, eth0, and lisp0 are added to a single
bridge instance, and become numbered 1, 2, and 3 respectively:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ovs-vsctl add-br br0
$ ovs-vsctl add-port br0 tap0
$ ovs-vsctl add-port br0 eth0
$ ovs-vsctl add-port br0 lisp0 \
  -- set Interface lisp0 type=lisp options:remote_ip=flow options:key=flow
</pre></div>
</div>
<p>The last command sets up flow based tunneling on the lisp0 interface.  From
the LISP point of view, this is like having the Tunnel Router map cache
implemented as flow rules.</p>
<p>Flows on br0 should be configured as follows:</p>
<div class="highlight-python"><div class="highlight"><pre>priority=3,dl_dst=02:00:00:00:00:00,action=mod_dl_dst:&lt;VMx_MAC&gt;,output:1
priority=2,in_port=1,dl_type=0x0806,action=NORMAL
priority=1,in_port=1,dl_type=0x0800,vlan_tci=0,nw_src=&lt;EID_prefix&gt;,action=set_field:&lt;OVSx_IP&gt;-&gt;tun_dst,output:3
priority=0,action=NORMAL
</pre></div>
</div>
<p>The third rule is like a map cache entry: the <tt class="docutils literal"><span class="pre">&lt;EID_prefix&gt;</span></tt> specified by the
<tt class="docutils literal"><span class="pre">nw_src</span></tt> match field is mapped to the RLOC <tt class="docutils literal"><span class="pre">&lt;OVSx_IP&gt;</span></tt>, which is set as the
tunnel destination for this particular flow.</p>
<p>Optionally, if you want to use Instance ID in a flow, you can add
<tt class="docutils literal"><span class="pre">set_tunnel:&lt;IID&gt;</span></tt> to the action list.</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../contents.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="ssl.html"
                        title="previous chapter">Open vSwitch with SSL</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="tunneling.html"
                        title="next chapter">Connecting VMs Using Tunnels</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/howto/lisp.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="tunneling.html" title="Connecting VMs Using Tunnels"
             >next</a> |</li>
        <li class="right" >
          <a href="ssl.html" title="Open vSwitch with SSL"
             >previous</a> |</li>
        <li><a href="../contents.html">Open vSwitch 2.6.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >How-to Guides</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2016, The Open vSwitch Development Community.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>