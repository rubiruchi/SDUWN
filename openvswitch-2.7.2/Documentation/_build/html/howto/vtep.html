<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>How to Use the VTEP Emulator &mdash; Open vSwitch 2.6.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.6.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Open vSwitch 2.6.0 documentation" href="../index.html" />
    <link rel="up" title="How-to Guides" href="index.html" />
    <link rel="next" title="Monitoring VM Trafic Using sFlow" href="sflow.html" />
    <link rel="prev" title="Quality of Service (QoS) Rate Limiting" href="qos.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="sflow.html" title="Monitoring VM Trafic Using sFlow"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="qos.html" title="Quality of Service (QoS) Rate Limiting"
             accesskey="P">previous</a> |</li>
        <li><a href="../contents.html">Open vSwitch 2.6.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">How-to Guides</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="how-to-use-the-vtep-emulator">
<h1>How to Use the VTEP Emulator<a class="headerlink" href="#how-to-use-the-vtep-emulator" title="Permalink to this headline">¶</a></h1>
<p>This document explains how to use ovs-vtep, a VXLAN Tunnel Endpoint (VTEP)
emulator that uses Open vSwitch for forwarding. VTEPs are the entities that
handle VXLAN frame encapsulation and decapsulation in a network.</p>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>The VTEP emulator is a Python script that invokes calls to tools like vtep-ctl
and ovs-vsctl. It is only useful when Open vSwitch daemons like ovsdb-server
and ovs-vswitchd are running and installed. To do this, either:</p>
<ul class="simple">
<li>Follow the instructions in <a class="reference internal" href="../intro/install/general.html"><em>Open vSwitch on Linux, FreeBSD and NetBSD</em></a> (don&#8217;t start any
daemons yet).</li>
<li>Follow the instructions in <a class="reference internal" href="../intro/install/debian.html"><em>Debian Packaging for Open vSwitch</em></a> and then install the
<tt class="docutils literal"><span class="pre">openvswitch-vtep</span></tt> package (if operating on a debian based machine).  This
will automatically start the daemons.</li>
</ul>
</div>
<div class="section" id="design">
<h2>Design<a class="headerlink" href="#design" title="Permalink to this headline">¶</a></h2>
<p>At the end of this process, you should have the following setup:</p>
<div class="highlight-python"><div class="highlight"><pre>Architecture

+---------------------------------------------------+
| Host Machine                                      |
|                                                   |
|                                                   |
|       +---------+ +---------+                     |
|       |         | |         |                     |
|       |   VM1   | |   VM2   |                     |
|       |         | |         |                     |
|       +----o----+ +----o----+                     |
|            |           |                          |
| br0 +------o-----------o--------------------o--+  |
|            p0          p1                  br0    |
|                                                   |
|                                                   |
|                              +------+   +------+  |
+------------------------------| eth0 |---| eth1 |--+
                               +------+   +------+
                               10.1.1.1   10.2.2.1
                  MANAGEMENT      |          |
                +-----------------o----+     |
                                             |
                             DATA/TUNNEL     |
                           +-----------------o---+
</pre></div>
</div>
<p>Some important points.</p>
<ul class="simple">
<li>We will use Open vSwitch to create our &#8220;physical&#8221; switch labeled <tt class="docutils literal"><span class="pre">br0</span></tt></li>
<li>Our &#8220;physical&#8221; switch <tt class="docutils literal"><span class="pre">br0</span></tt> will have one internal port also named <tt class="docutils literal"><span class="pre">br0</span></tt>
and two &#8220;physical&#8221; ports, namely <tt class="docutils literal"><span class="pre">p0</span></tt> and <tt class="docutils literal"><span class="pre">p1</span></tt>.</li>
<li>The host machine may have two external interfaces. We will use <tt class="docutils literal"><span class="pre">eth0</span></tt> for
management traffic and <tt class="docutils literal"><span class="pre">eth1</span></tt> for tunnel traffic (One can use a single
interface to achieve both). Please take note of their IP addresses in the
diagram. You do not have to use exactly the same IP addresses. Just know that
the above will be used in the steps below.</li>
<li>You can optionally connect physical machines instead of virtual machines to
switch <tt class="docutils literal"><span class="pre">br0</span></tt>. In that case:<ul>
<li>Make sure you have two extra physical interfaces in your host machine,
<tt class="docutils literal"><span class="pre">eth2</span></tt> and <tt class="docutils literal"><span class="pre">eth3</span></tt>.</li>
<li>In the rest of this doc, replace <tt class="docutils literal"><span class="pre">p0</span></tt> with <tt class="docutils literal"><span class="pre">eth2</span></tt> and <tt class="docutils literal"><span class="pre">p1</span></tt> with
<tt class="docutils literal"><span class="pre">eth3</span></tt>.</li>
</ul>
</li>
</ul>
<ol class="arabic simple" start="5">
<li>In addition to implementing <tt class="docutils literal"><span class="pre">p0</span></tt> and <tt class="docutils literal"><span class="pre">p1</span></tt> as physical interfaces, you
can also optionally implement them as standalone TAP devices, or VM
interfaces for simulation.</li>
<li>Creating and attaching the VMs is outside the scope of this document and is
included in the diagram for reference purposes only.</li>
</ol>
</div>
<div class="section" id="startup">
<h2>Startup<a class="headerlink" href="#startup" title="Permalink to this headline">¶</a></h2>
<p>These instructions describe how to run with a single ovsdb-server instance that
handles both the OVS and VTEP schema. You can skip steps 1-3 if you installed
using the debian packages as mentioned in step 2 of the &#8220;Requirements&#8221; section.</p>
<ol class="arabic">
<li><p class="first">Create the initial OVS and VTEP schemas:</p>
<div class="highlight-python"><div class="highlight"><pre> $ ovsdb-tool create /etc/openvswitch/ovs.db vswitchd/vswitch.ovsschema
 $ ovsdb-tool create /etc/openvswitch/vtep.db vtep/vtep.ovsschema
```
</pre></div>
</div>
</li>
<li><p class="first">Start ovsdb-server and have it handle both databases:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ovsdb-server --pidfile --detach --log-file \
    --remote punix:/var/run/openvswitch/db.sock \
    --remote=db:hardware_vtep,Global,managers \
    /etc/openvswitch/ovs.db /etc/openvswitch/vtep.db
</pre></div>
</div>
</li>
<li><p class="first">Start ovs-vswitchd as normal:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ovs-vswitchd --log-file --detach --pidfile \
    unix:/var/run/openvswitch/db.sock
</pre></div>
</div>
</li>
<li><p class="first">Create a &#8220;physical&#8221; switch and its ports in OVS:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ovs-vsctl add-br br0
$ ovs-vsctl add-port br0 p0
$ ovs-vsctl add-port br0 p1
</pre></div>
</div>
</li>
<li><p class="first">Configure the physical switch in the VTEP database:</p>
<div class="highlight-python"><div class="highlight"><pre>$ vtep-ctl add-ps br0
$ vtep-ctl set Physical_Switch br0 tunnel_ips=10.2.2.1
</pre></div>
</div>
</li>
<li><p class="first">Start the VTEP emulator. If you installed the components following
<a class="reference internal" href="../intro/install/general.html"><em>Open vSwitch on Linux, FreeBSD and NetBSD</em></a>, run the following from the <tt class="docutils literal"><span class="pre">vtep</span></tt>
directory:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ./ovs-vtep --log-file=/var/log/openvswitch/ovs-vtep.log \
    --pidfile=/var/run/openvswitch/ovs-vtep.pid \
    --detach br0
</pre></div>
</div>
<p>If the installation was done by installing the openvswitch-vtep package, you
can find ovs-vtep at <tt class="docutils literal"><span class="pre">/usr/share/openvswitch/scripts</span></tt>.</p>
</li>
<li><p class="first">Configure the VTEP database&#8217;s manager to point at an NVC:</p>
<div class="highlight-python"><div class="highlight"><pre>$ vtep-ctl set-manager tcp:&lt;CONTROLLER IP&gt;:6640
</pre></div>
</div>
<p>Where <tt class="docutils literal"><span class="pre">&lt;CONTROLLER</span> <span class="pre">IP&gt;</span></tt> is your controller&#8217;s IP address that is accessible
via the Host Machine&#8217;s eth0 interface.</p>
</li>
</ol>
</div>
<div class="section" id="simulating-an-nvc">
<h2>Simulating an NVC<a class="headerlink" href="#simulating-an-nvc" title="Permalink to this headline">¶</a></h2>
<p>A VTEP implementation expects to be driven by a Network Virtualization
Controller (NVC), such as NSX.  If one does not exist, it&#8217;s possible to use
vtep-ctl to simulate one:</p>
<ol class="arabic">
<li><p class="first">Create a logical switch:</p>
<div class="highlight-python"><div class="highlight"><pre>$ vtep-ctl add-ls ls0
</pre></div>
</div>
</li>
<li><p class="first">Bind the logical switch to a port:</p>
<div class="highlight-python"><div class="highlight"><pre>$ vtep-ctl bind-ls br0 p0 0 ls0
$ vtep-ctl set Logical_Switch ls0 tunnel_key=33
</pre></div>
</div>
</li>
<li><p class="first">Direct unknown destinations out a tunnel.</p>
<p>For handling L2 broadcast, multicast and unknown unicast traffic, packets
can be sent to all members of a logical switch referenced by a physical
switch.  The &#8220;unknown-dst&#8221; address below is used to represent these packets.
There are different modes to replicate the packets.  The default mode of
replication is to send the traffic to a service node, which can be a
hypervisor, server or appliance, and let the service node handle replication
to other transport nodes (hypervisors or other VTEP physical switches).
This mode is called <em>service node</em> replication.  An alternate mode of
replication, called <em>source node</em> replication, involves the source node
sending to all other transport nodes.  Hypervisors are always responsible
for doing their own replication for locally attached VMs in both modes.
Service node mode is the default.  Service node replication mode is
considered a basic requirement because it only requires sending the packet
to a single transport node.  The following configuration is for service node
replication mode as only a single transport node destination is specified
for the unknown-dst address:</p>
<div class="highlight-python"><div class="highlight"><pre>$ vtep-ctl add-mcast-remote ls0 unknown-dst 10.2.2.2
</pre></div>
</div>
</li>
<li><p class="first">Optionally, change the replication mode from a default of <tt class="docutils literal"><span class="pre">service_node</span></tt>
to <tt class="docutils literal"><span class="pre">source_node</span></tt>, which can be done at the logical switch level:</p>
<div class="highlight-python"><div class="highlight"><pre>$ vtep-ctl set-replication-mode ls0 source_node
</pre></div>
</div>
</li>
<li><p class="first">Direct unicast destinations out a different tunnel:</p>
<div class="highlight-python"><div class="highlight"><pre>$ vtep-ctl add-ucast-remote ls0 00:11:22:33:44:55 10.2.2.3
</pre></div>
</div>
</li>
</ol>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../contents.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../contents.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">How to Use the VTEP Emulator</a><ul>
<li><a class="reference internal" href="#requirements">Requirements</a></li>
<li><a class="reference internal" href="#design">Design</a></li>
<li><a class="reference internal" href="#startup">Startup</a></li>
<li><a class="reference internal" href="#simulating-an-nvc">Simulating an NVC</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="qos.html"
                        title="previous chapter">Quality of Service (QoS) Rate Limiting</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="sflow.html"
                        title="next chapter">Monitoring VM Trafic Using sFlow</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/howto/vtep.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="sflow.html" title="Monitoring VM Trafic Using sFlow"
             >next</a> |</li>
        <li class="right" >
          <a href="qos.html" title="Quality of Service (QoS) Rate Limiting"
             >previous</a> |</li>
        <li><a href="../contents.html">Open vSwitch 2.6.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >How-to Guides</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2016, The Open vSwitch Development Community.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>