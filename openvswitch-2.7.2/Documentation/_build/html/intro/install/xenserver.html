<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Open vSwitch on Citrix XenServer &mdash; Open vSwitch 2.6.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.6.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Open vSwitch 2.6.0 documentation" href="../../index.html" />
    <link rel="up" title="Installing Open vSwitch" href="index.html" />
    <link rel="next" title="Open vSwitch without Kernel Support" href="userspace.html" />
    <link rel="prev" title="Open vSwitch on Windows" href="windows.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="userspace.html" title="Open vSwitch without Kernel Support"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="windows.html" title="Open vSwitch on Windows"
             accesskey="P">previous</a> |</li>
        <li><a href="../../contents.html">Open vSwitch 2.6.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Getting Started</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Installing Open vSwitch</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="open-vswitch-on-citrix-xenserver">
<h1>Open vSwitch on Citrix XenServer<a class="headerlink" href="#open-vswitch-on-citrix-xenserver" title="Permalink to this headline">¶</a></h1>
<p>This document describes how to build and install Open vSwitch on a Citrix
XenServer host.  If you want to install Open vSwitch on a generic Linux or BSD
host, refer to <a class="reference internal" href="general.html"><em>Open vSwitch on Linux, FreeBSD and NetBSD</em></a> instead.</p>
<p>Open vSwitch should work with XenServer 5.6.100 and later.  However, Open
vSwitch requires Python 2.7 or later, so using Open vSwitch with XenServer 6.5
or earlier requires installing Python 2.7.</p>
<div class="section" id="building">
<h2>Building<a class="headerlink" href="#building" title="Permalink to this headline">¶</a></h2>
<p>You may build from an Open vSwitch distribution tarball or from an Open vSwitch
Git tree.  The recommended build environment to build RPMs for Citrix XenServer
is the DDK VM available from Citrix.</p>
<ol class="arabic">
<li><p class="first">If you are building from an Open vSwitch Git tree, then you will need to
first create a distribution tarball by running:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ./boot.sh
$ ./configure
$ make dist
</pre></div>
</div>
<p>You cannot run this in the DDK VM, because it lacks tools that are necessary
to bootstrap the Open vSwitch distribution.  Instead, you must run this on a
machine that has the tools listed in <a class="reference internal" href="general.html#general-install-reqs"><em>Installation Requirements</em></a> as
prerequisites for building from a Git tree.</p>
</li>
<li><p class="first">Copy the distribution tarball into <tt class="docutils literal"><span class="pre">/usr/src/redhat/SOURCES</span></tt> inside
the DDK VM.</p>
</li>
<li><p class="first">In the DDK VM, unpack the distribution tarball into a temporary directory
and &#8220;cd&#8221; into the root of the distribution tarball.</p>
</li>
<li><p class="first">To build Open vSwitch userspace, run:</p>
<div class="highlight-python"><div class="highlight"><pre>$ rpmbuild -bb xenserver/openvswitch-xen.spec
</pre></div>
</div>
<p>This produces three RPMs in <tt class="docutils literal"><span class="pre">/usr/src/redhat/RPMS/i386</span></tt>:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">openvswitch</span></tt></li>
<li><tt class="docutils literal"><span class="pre">openvswitch-modules-xen</span></tt></li>
<li><tt class="docutils literal"><span class="pre">openvswitch-debuginfo</span></tt></li>
</ul>
<p>The above command automatically runs the Open vSwitch unit tests.  To
disable the unit tests, run:</p>
<div class="highlight-python"><div class="highlight"><pre>$ rpmbuild -bb --without check xenserver/openvswitch-xen.spec
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="build-parameters">
<h2>Build Parameters<a class="headerlink" href="#build-parameters" title="Permalink to this headline">¶</a></h2>
<p><tt class="docutils literal"><span class="pre">openvswitch-xen.spec</span></tt> needs to know a number of pieces of information about
the XenServer kernel.  Usually, it can figure these out for itself, but if it
does not do it correctly then you can specify them yourself as parameters to
the build.  Thus, the final <tt class="docutils literal"><span class="pre">rpmbuild</span></tt> step above can be elaborated as:</p>
<div class="highlight-python"><div class="highlight"><pre>$ VERSION=&lt;Open vSwitch version&gt;
$ KERNEL_NAME=&lt;Xen Kernel name&gt;
$ KERNEL_VERSION=&lt;Xen Kernel version&gt;
$ KERNEL_FLAVOR=&lt;Xen Kernel flavor(suffix)&gt;
$ rpmbuild \
     -D &quot;openvswitch_version $VERSION&quot; \
     -D &quot;kernel_name $KERNEL_NAME&quot; \
     -D &quot;kernel_version $KERNEL_VERSION&quot; \
     -D &quot;kernel_flavor $KERNEL_FLAVOR&quot; \
     -bb xenserver/openvswitch-xen.spec
</pre></div>
</div>
<p>where:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">&lt;openvswitch</span> <span class="pre">version&gt;</span></tt></dt>
<dd>is the version number that appears in the name of the Open vSwitch tarball,
e.g. 0.90.0.</dd>
<dt><tt class="docutils literal"><span class="pre">&lt;Xen</span> <span class="pre">Kernel</span> <span class="pre">name&gt;</span></tt></dt>
<dd>is the name of the XenServer kernel package, e.g. <tt class="docutils literal"><span class="pre">kernel-xen</span></tt> or
<tt class="docutils literal"><span class="pre">kernel-NAME-xen</span></tt>, without the <tt class="docutils literal"><span class="pre">kernel-</span></tt> prefix.</dd>
<dt><tt class="docutils literal"><span class="pre">&lt;Xen</span> <span class="pre">Kernel</span> <span class="pre">version&gt;</span></tt></dt>
<dd><p class="first">is the output of:</p>
<div class="highlight-python"><div class="highlight"><pre>$ rpm -q --queryformat &quot;%{Version}-%{Release}&quot; &lt;kernel-devel-package&gt;,
</pre></div>
</div>
<p class="last">e.g. <tt class="docutils literal"><span class="pre">2.6.32.12-0.7.1.xs5.6.100.323.170596</span></tt>, where
<tt class="docutils literal"><span class="pre">&lt;kernel-devel-package&gt;</span></tt> is the name of the <tt class="docutils literal"><span class="pre">-devel</span></tt> package
corresponding to <tt class="docutils literal"><span class="pre">&lt;Xen</span> <span class="pre">Kernel</span> <span class="pre">name&gt;</span></tt>.</p>
</dd>
<dt><tt class="docutils literal"><span class="pre">&lt;Xen</span> <span class="pre">Kernel</span> <span class="pre">flavor</span> <span class="pre">(suffix)&gt;</span></tt></dt>
<dd>is either <tt class="docutils literal"><span class="pre">xen</span></tt> or <tt class="docutils literal"><span class="pre">kdump</span></tt>, where <tt class="docutils literal"><span class="pre">xen</span></tt> flavor is the main running
kernel flavor and the <tt class="docutils literal"><span class="pre">kdump</span></tt> flavor is the crashdump kernel flavor.
Commonly, one would specify <tt class="docutils literal"><span class="pre">xen</span></tt> here.</dd>
</dl>
<p>For XenServer 6.5 or above, the kernel version naming no longer contains
KERNEL_FLAVOR.  In fact, only providing the <tt class="docutils literal"><span class="pre">uname</span> <span class="pre">-r</span></tt> output is enough.  So,
the final <tt class="docutils literal"><span class="pre">rpmbuild</span></tt> step changes to:</p>
<div class="highlight-python"><div class="highlight"><pre>$ KERNEL_UNAME=&lt;`uname -r` output&gt;
$ rpmbuild \
    -D &quot;kenel_uname $KERNEL_UNAME&quot; \
    -bb xenserver/openvswitch-xen.spec
</pre></div>
</div>
</div>
<div class="section" id="installing-open-vswitch-for-xenserver">
<h2>Installing Open vSwitch for XenServer<a class="headerlink" href="#installing-open-vswitch-for-xenserver" title="Permalink to this headline">¶</a></h2>
<p>To install Open vSwitch on a XenServer host, or to upgrade to a newer version,
copy the <tt class="docutils literal"><span class="pre">openvswitch</span></tt> and <tt class="docutils literal"><span class="pre">openvswitch-modules-xen</span></tt> RPMs to that host with
<tt class="docutils literal"><span class="pre">scp</span></tt>, then install them with <tt class="docutils literal"><span class="pre">rpm</span> <span class="pre">-U</span></tt>, e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre>$ scp openvswitch-$VERSION-1.i386.rpm \
    openvswitch-modules-xen-$XEN_KERNEL_VERSION-$VERSION-1.i386.rpm \
    root@&lt;host&gt;:
# Enter &lt;host&gt;&#39;s root password.
$ ssh root@&lt;host&gt;
# Enter &lt;host&gt;&#39;s root password again.
$ rpm -U openvswitch-$VERSION-1.i386.rpm \
    openvswitch-modules-xen-$XEN_KERNEL_VERSION-$VERSION-1.i386.rpm
</pre></div>
</div>
<p>To uninstall Open vSwitch from a XenServer host, remove the packages:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ssh root@&lt;host&gt;
# Enter &lt;host&gt;&#39;s root password again.
$ rpm -e openvswitch openvswitch-modules-xen-$XEN_KERNEL_VERSION
</pre></div>
</div>
<p>After installing or uninstalling Open vSwitch, the XenServer should be rebooted
as soon as possible.</p>
</div>
<div class="section" id="open-vswitch-boot-sequence-on-xenserver">
<h2>Open vSwitch Boot Sequence on XenServer<a class="headerlink" href="#open-vswitch-boot-sequence-on-xenserver" title="Permalink to this headline">¶</a></h2>
<p>When Open vSwitch is installed on XenServer, its startup script
<tt class="docutils literal"><span class="pre">/etc/init.d/openvswitch</span></tt> runs early in boot.  It does roughly the following:</p>
<ul class="simple">
<li>Loads the OVS kernel module, openvswitch.</li>
<li>Starts ovsdb-server, the OVS configuration database.</li>
<li>XenServer expects there to be no bridges configured at startup, but the OVS
configuration database likely still has bridges configured from before
reboot.  To match XenServer expectations, the startup script deletes all
configured bridges from the database.</li>
<li>Starts ovs-vswitchd, the OVS switching daemon.</li>
</ul>
<p>At this point in the boot process, then, there are no Open vSwitch bridges,
even though all of the Open vSwitch daemons are running.  Later on in boot,
<tt class="docutils literal"><span class="pre">/etc/init.d/management-interface</span></tt> (part of XenServer, not Open vSwitch)
creates the bridge for the XAPI management interface by invoking
<tt class="docutils literal"><span class="pre">/opt/xensource/libexec/interface-reconfigure</span></tt>.  Normally this program
consults XAPI&#8217;s database to obtain information about how to configure the
bridge, but XAPI is not running yet(*) so it instead consults
<tt class="docutils literal"><span class="pre">/var/xapi/network.dbcache</span></tt>, which is a cached copy of the most recent
network configuration.</p>
<dl class="docutils">
<dt>(*) Even if XAPI were running, if this XenServer node is a pool slave then the</dt>
<dd>query would have to consult the master, which requires network access,
which begs the question of how to configure the management interface.</dd>
</dl>
<p>XAPI starts later on in the boot process.  XAPI can then create other bridges
on demand using <tt class="docutils literal"><span class="pre">/opt/xensource/libexec/interface-reconfigure</span></tt>.  Now that
XAPI is running, that program consults XAPI directly instead of reading the
cache.</p>
<p>As part of its own startup, XAPI invokes the Open vSwitch XAPI plugin script
<tt class="docutils literal"><span class="pre">/etc/xapi.d/openvswitch-cfg-update</span></tt> passing the <tt class="docutils literal"><span class="pre">update</span></tt> command.  The
plugin script does roughly the following:</p>
<ul class="simple">
<li>Calls <tt class="docutils literal"><span class="pre">/opt/xensource/libexec/interface-reconfigure</span></tt> with the <tt class="docutils literal"><span class="pre">rewrite</span></tt>
command, to ensure that the network cache is up-to-date.</li>
<li>Queries the Open vSwitch manager setting (named <tt class="docutils literal"><span class="pre">vswitch_controller</span></tt>) from
the XAPI database for the XenServer pool.</li>
<li>If XAPI and OVS are configured for different managers, or if OVS is
configured for a manager but XAPI is not, runs <tt class="docutils literal"><span class="pre">ovs-vsctl</span> <span class="pre">emer-reset</span></tt> to
bring the Open vSwitch configuration to a known state.  One effect of
emer-reset is to deconfigure any manager from the OVS database.</li>
<li>If XAPI is configured for a manager, configures the OVS manager to match with
<tt class="docutils literal"><span class="pre">ovs-vsctl</span> <span class="pre">set-manager</span></tt>.</li>
</ul>
</div>
<div class="section" id="notes">
<h2>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The Open vSwitch boot sequence only configures an OVS configuration database
manager.  There is no way to directly configure an OpenFlow controller on
XenServer and, as a consequence of the step above that deletes all of the
bridges at boot time, controller configuration only persists until XenServer
reboot.  The configuration database manager can, however, configure
controllers for bridges.  See the BUGS section of ovs-testcontroller(8) for
more information on this topic.</li>
<li>The Open vSwitch startup script automatically adds a firewall rule to allow
GRE traffic. This rule is needed for the XenServer feature called &#8220;Cross-Host
Internal Networks&#8221; (CHIN) that uses GRE. If a user configures tunnels other
than GRE (ex: Geneve, VXLAN, LISP), they will have to either manually add a
iptables firewall rule to allow the tunnel traffic or add it through a
startup script (Please refer to the &#8220;enable-protocol&#8221; command in the
ovs-ctl(8) manpage).</li>
</ul>
</div>
<div class="section" id="reporting-bugs">
<h2>Reporting Bugs<a class="headerlink" href="#reporting-bugs" title="Permalink to this headline">¶</a></h2>
<p>Please report problems to <a class="reference external" href="mailto:bugs&#37;&#52;&#48;openvswitch&#46;org">bugs<span>&#64;</span>openvswitch<span>&#46;</span>org</a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../contents.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../../contents.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Open vSwitch on Citrix XenServer</a><ul>
<li><a class="reference internal" href="#building">Building</a></li>
<li><a class="reference internal" href="#build-parameters">Build Parameters</a></li>
<li><a class="reference internal" href="#installing-open-vswitch-for-xenserver">Installing Open vSwitch for XenServer</a></li>
<li><a class="reference internal" href="#open-vswitch-boot-sequence-on-xenserver">Open vSwitch Boot Sequence on XenServer</a></li>
<li><a class="reference internal" href="#notes">Notes</a></li>
<li><a class="reference internal" href="#reporting-bugs">Reporting Bugs</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="windows.html"
                        title="previous chapter">Open vSwitch on Windows</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="userspace.html"
                        title="next chapter">Open vSwitch without Kernel Support</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/intro/install/xenserver.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="userspace.html" title="Open vSwitch without Kernel Support"
             >next</a> |</li>
        <li class="right" >
          <a href="windows.html" title="Open vSwitch on Windows"
             >previous</a> |</li>
        <li><a href="../../contents.html">Open vSwitch 2.6.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Getting Started</a> &raquo;</li>
          <li><a href="index.html" >Installing Open vSwitch</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2016, The Open vSwitch Development Community.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>